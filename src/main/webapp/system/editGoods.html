<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>添加人员</title>
		<link href="../css/style.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="../layer/mobile/need/layer.css" />
		<script type="text/javascript" src="../js/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript" src="../layer/layer.js"></script>
		<style>
			input[type=file] {
				display: none;
			}
			
			select {
				width: 150px;
				border: 1px solid #a7b5bc;
				padding: 8px 5px;
			}
		</style>
	</head>

	<body>

		<div class="place">
			<span>位置：</span>
			<ul class="placeul">
				<li>
					<a href="#">藏品展示管理</a>
				</li>
				<li>
					<a href="#">藏品列表</a>
				</li>
			</ul>
		</div>

		<div class="formbody">
			<div class="formtitle">
				<span>编辑藏品信息：</span>
			</div>
			<form name='addForm'>
				<ul class="forminfo">
					<li>
						<label>藏品编号</label>
						<input name="tNumber" id='tNumber' type="text" class="dfinput" placeholder="请输入藏品名称" />
					</li>
					<li>
						<label>藏品名称</label>
						<input name="tName" id="tName" type="text" class="dfinput" placeholder="请输入藏品名称" />
					</li>
					<li>
						<label>所属朝代</label>
						<select class="select2" name="tDynasty" id="tDynasty">
						</select>
					</li>
					<li>
						<label>藏品URL</label>
						<input name="" type="text" id="t3dUrl" class="dfinput" placeholder="如：114.215.84.169：10832" />
					</li>
					<li>
						<label>藏品图例</label>
						<input name="" id="file" accept="image/*" onchange="getImg()" type="file" style="width: 50px;height: 50px;" alt="缩略图" />
						<img src="../images/add.png" id="img_sel" height="70px" onclick="selectedImg()" />
					</li>
					<li>
						<label>藏品介绍</label>
						<textarea class="textinput" id="tDesc" rows="" cols="" name=""></textarea>
					</li>
				</ul>
				<p>
					<span class="btn" onclick="submitGoods()">发布藏品</span>
				</p>
			</form>
		</div>
		<script type="text/javascript">
			var editId = localStorage.getItem('editGoodsId'),
				ifChange = false;
			$('.imgtable tbody tr:odd').addClass('odd');
			$(function() {
				initDynasty()
			})

			function selectedImg() {
				$('#file').click()
			}

			function getImg() {
				ifChange = true;
				//检验是否为图像文件  
				var file = document.getElementById("file").files[0];
				if(!/image\/\w+/.test(file.type)) {
					alert("请选择图片！");
					return false;
				}
				var reader = new FileReader();
				//将文件以Data URL形式读入页面  
				reader.readAsDataURL(file);
				reader.onload = function(e) {
					document.getElementById('img_sel').src = this.result
				}
			}

			function initDynasty() {
				JQajax('dynasty/getdynasties', {}, function(data) {
					$('#dynasty').html('');
					$.each(data, function(index, item) {
						if(item.isdelete != 0) {
							return false;
						}
						$('.select2').append("<option value='" + item.dId + "'>" + item.dName + "</option>");
					})
					JQajax('treasure/getbacktreasurebyid', {
						'tId': editId
					}, function(data) {
						$('#tName').val(data.tName);
						$('#tNumber').val(data.tNumber);
						$(".select2 option[value='" + data.tDynasty + "']").attr('selected', 'selected');
						$('#t3dUrl').val(data.t3dUrl);
						$('#img_sel').attr('src', data.tCoverUrl);
						$('#tDesc').val(data.tDesc);
					})
				})
			}

			function submitGoods() {
				var tname = $.trim($('#tName').val()),
					tnumber = $.trim($('#tNumber').val()),
					tdynasty = $('.select2 option:selected').val(),
					t3dUrl = $.trim($('#t3dUrl').val()),
					file = document.getElementById('file').files[0],
					tfile = $('#file').val(),
					tdesc = $.trim($('#tDesc').val());
				if(!tname || !tnumber || !tdynasty || !t3dUrl || !tdesc) {
					alert('请填写完整')
					return
				}
				var form = new Object();
				form.tId = editId;
				form.tName = tname;
				form.tNumber = tnumber;
				form.tDynasty = tdynasty;
				form.t3dUrl = t3dUrl;
				form.file = tfile;
				form.tDesc = tdesc;
				if(!ifChange) {
					$.ajax({
						type: "post",
						url: apiUrl + "treasure/updatetreasure",
						data: form,
						dataType: 'json',
						async: true,
						success: function(data) {
							if(data == 1) {
								msg('修改成功')
								setTimeout(function() {
									window.history.go(-1)
								}, 2000)
							} else {
								msgEr('添加失败')
							}
						}
					});
				} else {
					var imgForm = new FormData();
					imgForm.append('file', file);
					$.ajax({
						type: "post",
						url: apiUrl + "treasure/uptreasurpic",
						data: imgForm,
						async: true,
						cache: false,
						contentType: false,
						processData: false,
						dataType: 'json',
						success: function(data) {
							delete form.file;
							form.tCoverUrl = data.path;
							$.ajax({
								type: "post",
								url: apiUrl + "treasure/updatetreasure",
								data: form,
								dataType: 'json',
								async: true,
								success: function(data) {
									if(data == 1) {
										msg('修改成功')
										setTimeout(function() {
											window.history.go(-1)
										}, 2000)
									} else {
										msgEr('添加失败')
									}
								}
							});
						}
					});
				}
			}
		</script>
	</body>

</html>